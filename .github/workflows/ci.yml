name: CI/CD - Node.js 18 to Docker Hub

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

  build-and-push:
    runs-on: ubuntu-latest
    needs: test
    # SUPPRIMEZ la condition 'if' temporairement pour debug
    # if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: DEBUG 1 - Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        continue-on-error: true

      - name: DEBUG 2 - Test des secrets
        run: |
          echo "=== TEST DES SECRETS ==="
          echo "Username length: ${#DOCKER_USERNAME}"
          echo "Password length: ${#DOCKER_PASSWORD}"
          
          # Test format token Docker
          if [[ "$DOCKER_PASSWORD" == dckr_pat_* ]]; then
            echo "✅ Token format Docker valide"
          else
            echo "❌ Mauvais format token (doit commencer par dckr_pat_)"
          fi
          
          # Montre 4 premières lettres du username
          echo "Username (début): ${DOCKER_USERNAME:0:4}***"

      - name: DEBUG 3 - Test login SIMPLE
        run: |
          echo "=== TEST LOGIN SIMPLE ==="
          # Écrit le token dans un fichier temporaire
          echo "$DOCKER_PASSWORD" > /tmp/docker_token
          
          # Essaye de login
          docker login -u "$DOCKER_USERNAME" --password-stdin < /tmp/docker_token 2>&1 | tee /tmp/login.log
          
          LOGIN_EXIT_CODE=$?
          echo "Code de sortie login: $LOGIN_EXIT_CODE"
          
          if [ $LOGIN_EXIT_CODE -eq 0 ]; then
            echo "✅ LOGIN RÉUSSI!"
            docker logout
          else
            echo "❌ LOGIN ÉCHOUÉ"
            echo "--- Dernières lignes d'erreur ---"
            tail -20 /tmp/login.log
          fi
          
          # Nettoie
          rm -f /tmp/docker_token /tmp/login.log
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

      - name: DEBUG 4 - Test build SANS push
        run: |
          echo "=== TEST BUILD SANS PUSH ==="
          echo "Fichier Dockerfile présent: $(ls -la Dockerfile 2>/dev/null && echo 'OUI' || echo 'NON')"
          
          # Test build simple
          docker build -t local-test:debug . 2>&1 | tail -30
          
          BUILD_EXIT_CODE=$?
          echo "Code de sortie build: $BUILD_EXIT_CODE"
          
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "✅ BUILD RÉUSSI!"
            docker rmi local-test:debug 2>/dev/null || true
          else
            echo "❌ BUILD ÉCHOUÉ"
          fi
